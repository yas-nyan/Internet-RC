<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>インターネットラジコン</title>
    <!-- Path to Framework7 Library CSS-->
    <link rel="stylesheet" href="css/framework7.ios.min.css">
    <link rel="stylesheet" href="css/framework7.ios.colors.min.css">
    <!-- Path to your custom app styles-->
    <link rel="stylesheet" href="css/my-app.css">
    
  </head>
  <body>
    <!-- Status bar overlay for fullscreen mode-->
    <div class="statusbar-overlay"></div>
    <!-- Panels overlay-->
    <div class="panel-overlay"></div>
    <!-- Left panel with reveal effect-->
    <div class="panel panel-left panel-reveal">
      <div class="content-block">
        <p>Left panel content goes here</p>
      </div>
    </div>
    <!-- Right panel with cover effect-->
    <div class="panel panel-right panel-cover">
      <div class="content-block">
        <p>Right panel content goes here</p>
      </div>
    </div>
    <!-- Views-->
    <div class="views">
      <!-- Your main view, should have "view-main" class-->
      <div class="view view-main">
        <!-- Top Navbar-->
        <div class="navbar">
          <div class="navbar-inner">
            <!-- We have home navbar without left link-->
            <div class="center sliding">インターネット自動車</div>
          </div>
        </div>
        <!-- Pages, because we need fixed-through navbar and toolbar, it has additional appropriate classes-->
        <div class="pages navbar-through toolbar-through">
          <!-- Page, data-page contains page name-->
          <div data-page="index" class="page">
            <!-- Scrollable page content-->
            <div class="page-content">
              <div class="content-block-title">設定</div>
              <div class="content-block">
                <div class="content-block-inner">
                    <div class="item-inner">
                        <div class="item-title label">アクセル</div>
                        <div class="item-input">
                            <div class="range-slider">
                                <input id="axel" type="range" min="100" max="200" step="1" >
                            </div>
                        </div>
                     </div>                    
                    <div class="item-inner">
                        <div class="item-title label">ステアリング:</div>
                        <div class="item-input">
                            <div class="range-slider">
                                <input id="steer" type="range" min="100" max="200" step="1" />
                            </div>
                        </div>
                     </div>                    
                    <!--label>アクセル:</label><input id="axel" type="range" min="100" max="200" step="1" />
                    <label>ステアリング:</label><input id="steer" type="range" min="100" max="200" step="1" /-->
                    <div class="row">
                      <div class="col-50">
                        <input id="reset" class="button button-big button-round" type="button" value="リセット"/>
                      </div>
                      <div class="col-50">
                        <input id="gyroOn" class="button button-big button-round" type="button" value="ジャイロ操作オン" >
                      </div>
                    </div>                        
                    <br>
                    <br>

                </div>
              </div>
              <div class="content-block-title">ステータス</div>
              <div class="content-block">
                <ul>
                    <li id="gyroStatus">ジャイロモードはオフです。</li> 
                   <!-- <li id="rotateStatus"></li> -->
                    <li id="axel-status"></li>
                    <li id="steer-status"></li>
                </ul>
              </div>
              <div class="content-block-title">加減速</div>
              <div class="content-block">
                  
                <div class="row">
                  <div class="col-50">
                    <div id="back_button" class="button button-big button-fill color-orange">BACKAREA</div>
                  </div>
                  <div class="col-50">
                    <div id="axel_button" class="button button-big button-fill color-green">AXELAREA</a>
                  </div>

                </div>
		 <div class="buttons-row" style="width:100%;margin-top:10px;">
                    <div href="#" id="brake_button" class="button button-big button-fill  color-red">BRAKEAREA</div>
                </div>  
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Path to Framework7 Library JS-->
    <script type="text/javascript" src="js/framework7.min.js"></script>
    <!-- Path to your app js-->
    <script type="text/javascript" src="js/my-app.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.3.js"></script>
    <script src="js/gyronorm.complete.min.js"></script>
    <script>
        var gyro = {
            status: false,
            x: 0,
            y: 0,
            z: 0
        };
        $(function () {
            var socket = io.connect("http://203.178.139.226:3000/");
            socket.on('connect', function () {
                alert("接続されました。");
            });
            socket.on('disconnect', function () {
                alert("切断されました");
            });
            //アクセルの情報を送信
            $("#axel").bind("change", function () {
                message = $(this).val();
                socket.emit("axel", message);
            });
            //ステアの情報を送信
            $("#steer").bind("change", function () {
                message = $(this).val();
                socket.emit("steer", message);
            });
            //帰ってきたデータをステータスにレンダリング
            socket.on("axel", function (data) {
                $('#axel-status').html("axel:" + data);
            });
            socket.on("steer", function (data) {
                $('#steer-status').html("steer:" + data);
            });
            //リセット
            $("#reset").bind("click", reset);
	   var axelstatus = 'stop';
           //アクセルボタン
            $("#axel_button").click(
                function(){
                    socket.emit("axel", 146);
		    axelstatus = "forward";
                }
                )
            //バックボタン
            $("#back_button").click(
                function(){
		    if(axelstatus == "forward"){
		    	brake();
		    }
		    socket.emit("axel", 150);	    
                    socket.emit("axel", 159);
		    socket.emit("axel", 159);
                    socket.emit("axel", 160);
                    socket.emit("axel", 162);
	            axelstatus = "back";
                }
                )
            //ブレーキボタン
            $("#brake_button").click(brake);
	    function brake(){
		if(axelstatus == "forward"){
		    	socket.emit("axel", 180);	
		    }else {
		    	socket.emit("axel", 150);
		    }
		    axelstatus = "stop";
	    }
            //ジャイロモード切り替え
            $("#gyroOn").on("click", function () {
                if (gyro.status === false) {
                    gyro.status = true;
                    alert("ジャイロモードになりました");
                    $("#gyroOn").val("ジャイロ操作オフ");
                    $("#gyroStatus").html("X:" + gyro.x + "Y:" + gyro.y + "Z:" + gyro.z);
                }
                else {
                    gyro.status = false;
		    $('gyroStatus').html("ジャイロモードはオフです。");
                    alert("ジャイロモードやめました");
                    $("#gyroOn").val("ジャイロ操作オン");
                }
            });
            function reset() {
                $("#steer").val(150);

                $("#axel").val(150);

            }
        var gn = new GyroNorm();
        var args = {
            frequency: 50, // ( How often the object sends the values - milliseconds )
            gravityNormalized: true, // ( If the garvity related values to be normalized )
            orientationBase: GyroNorm.GAME, // ( Can be GyroNorm.GAME or GyroNorm.WORLD. gn.GAME returns orientation values with respect to the head direction of the device. gn.WORLD returns the orientation values with respect to the actual north direction of the world. )
            decimalCount: 2, // ( How many digits after the decimal point will there be in the return values )
            logger: null, // ( Function to be called to log messages from gyronorm.js )
            screenAdjusted: false            // ( If set to true it will return screen adjusted values. )
        };
            gn.init(args).then(function () {
                gn.start(function (data) {
                	// Process:
			if(gyro.status == true){
                		$("#gyroStatus").html("ジャイロモード X:" + data.do.alpha + "Y:" + data.do.beta + "Z:" + data.do.gamma
                		);
			}else {
				$("gyroStatus").html("ジャイロモードはオフです。");
			}
                	//$("#rotateStatus").html("X:" + data.dm.alpha + "Y:" + data.dm.beta + "Z:" + data.dm.gamma
                	//);
                	var messageY = 　Math.round(data.do.beta + 150);
                	//アクセルがくっそムズカシイので１回やめます
                	/*var messageZ =   Math.round(-60 - data.do.gamma + 150);
                	if(120 <messageZ && messageZ <180){
                     	socket.emit("axel", messageZ);
                	}
                	*/
		//正常な範囲の値のみを投げる。
                if(gyro.status == true && 100 < messageY && messageY <200 ){
                    socket.emit("steer", messageY);
                }

                //if( -30 > data.do.gamma && -90 < data.do.gamma ){


                //}


                // data.do.beta     ( deviceorientation event beta value )
                // data.do.gamma    ( deviceorientation event gamma value )
                // data.do.absolute ( deviceorientation event absolute value )
                // data.dm.x        ( devicemotion event acceleration x value )
                // data.dm.y        ( devicemotion event acceleration y value )
                // data.dm.z        ( devicemotion event acceleration z value )

                // data.dm.gx       ( devicemotion event accelerationIncludingGravity x value )
                // data.dm.gy       ( devicemotion event accelerationIncludingGravity y value )
                // data.dm.gz       ( devicemotion event accelerationIncludingGravity z value )
                // data.dm.alpha    ( devicemotion event rotationRate alpha value )
                // data.dm.beta     ( devicemotion event rotationRate beta value )
                // data.dm.gamma    ( devicemotion event rotationRate gamma value )
            });
        }).catch(function (e) {
            // Catch if the DeviceOrientation or DeviceMotion is not supported by the browser or device
        });
        });
    </script>
   </body>
</html>
